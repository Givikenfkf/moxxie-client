name: Build native .so (Android)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build native libs
    runs-on: ubuntu-latest
    env:
      # Change to the exact NDK your project needs (match ndkVersion if present)
      NDK_VERSION: "25.2.9519653"
      ANDROID_PLATFORM: "android-33"
      BUILD_TOOLS_VERSION: "33.0.2"
      CMAKE_VERSION: "3.22.1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android cmdline-tools & SDK root (no packages)
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          # don't pass `packages:` here — we'll install them explicitly in the next step
          cmdline-tools-version: '12.0'

      - name: Locate sdkmanager and install required SDK packages (one-by-one, robust)
        shell: bash
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          # Candidate sdkmanager locations to try
          CANDIDATES=(
            "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
            "$ANDROID_SDK_ROOT/cmdline-tools/12.0/bin/sdkmanager"
            "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
            "/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager"
            "/usr/local/lib/android/sdk/tools/bin/sdkmanager"
          )

          SDKMANAGER=""
          for c in "${CANDIDATES[@]}"; do
            if [ -x "$c" ]; then
              SDKMANAGER="$c"
              break
            fi
          done

          if [ -z "$SDKMANAGER" ]; then
            echo "Could not find sdkmanager in expected locations. Listing $ANDROID_SDK_ROOT:"
            ls -R "$ANDROID_SDK_ROOT" || true
            exit 1
          fi

          echo "Using sdkmanager at: $SDKMANAGER"
          # packages to install — one item per array entry
          PACKS=(
            "platform-tools"
            "platforms;$ANDROID_PLATFORM"
            "build-tools;$BUILD_TOOLS_VERSION"
            "ndk;$NDK_VERSION"
            "cmake;$CMAKE_VERSION"
          )

          # Install each package separately (with a retry)
          for pack in "${PACKS[@]}"; do
            echo "Installing: $pack"
            if ! "$SDKMANAGER" "$pack"; then
              echo "First attempt failed for $pack — retrying after short sleep..."
              sleep 3
              if ! "$SDKMANAGER" "$pack"; then
                echo "Failed to install $pack"
                # show available remote list for debugging
                echo "Available packages (partial):"
                "$SDKMANAGER" --list | sed -n '1,200p' || true
                exit 1
              fi
            fi
          done

          # Accept licenses as final step
          yes | "$SDKMANAGER" --licenses || true
          echo "SDK packages installed."

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties') }}-${{ hashFiles('**/*.gradle*','**/gradle.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Show Java / Gradle versions (debug)
        run: |
          java -version
          ./gradlew -v

      - name: Build (assembleRelease)
        run: ./gradlew --no-daemon clean assembleRelease

      - name: Print where .so files might be
        run: |
          echo "==== Searching app/build for .so files ===="
          find app/build -type f -name "*.so" -print || true
          echo "==== Searching entire repo for .so files ===="
          find . -type f -name "*.so" -print || true

      - name: Collect .so files for upload
        run: |
          mkdir -p native-libs
          find . -type f -name '*.so' -exec rsync -R {} native-libs/ \; || true
          echo "Collected files:"
          ls -R native-libs || true

      - name: Upload native-libs artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: native-libs
